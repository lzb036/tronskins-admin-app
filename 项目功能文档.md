# TronSkins Admin App 功能文档

## 项目概述

TronSkins Admin App 是基于 uni-app 框架开发的跨平台后台管理应用，主要用于管理游戏饰品交易平台（TronSkins）的日常运营工作。

### 技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| uni-app | - | 跨平台应用开发框架 |
| Vue | 3.x | 前端框架 |
| TypeScript | - | 类型安全的编程语言 |
| uview-plus | 3.6.29 | UI 组件库 |
| Pinia | 3.0.4 | 状态管理 |
| pinia-plugin-persistedstate | - | Pinia 持久化插件 |
| vue-i18n | 9.14.4 | 国际化 |
| Sass/SCSS | - | CSS 预处理器 |

### 支持平台

- **App-plus**: Android / iOS 原生应用

---

## 项目结构

```
tronskins-admin-app/
├── api/                    # API 接口封装
│   ├── config/            # 请求配置、拦截器
│   ├── index.ts           # 请求入口
│   └── modules/           # 接口模块
│       ├── auth.ts        # 认证接口
│       ├── user.ts        # 用户接口
│       ├── withdraw.ts    # 提现接口
│       ├── trade.ts       # 交易接口
│       └── ticket.ts      # 工单接口
├── components/            # 公共组件
├── locales/              # 国际化语言包
│   ├── en.ts             # 英文
│   ├── zh.ts             # 中文
│   └── index.ts          # 语言配置导出
├── pages/                # 页面
│   ├── login/            # 登录页
│   ├── index/            # 首页（Tab容器）
│   ├── baseurl/          # 服务器地址管理
│   ├── tabs/             # 标签页
│   │   ├── withdraw.ts   # 提现管理
│   │   ├── trade.ts      # 交易管理
│   │   ├── ticket.ts     # 工单管理
│   │   └── profile.ts    # 个人信息
│   ├── trade-detail.vue      # 交易物品详情页
│   ├── trade-record-detail.vue # 交易记录详情页
│   ├── withdraw-detail.vue    # 提现详情页
│   ├── ticket-detail.vue      # 工单详情页
│   └── ticket-chat.vue        # 工单会话聊天页
├── static/               # 静态资源
├── store/                # 状态管理
│   ├── app.ts            # 应用状态
│   └── user.ts           # 用户状态
├── types/                # TypeScript 类型定义
│   └── api.d.ts          # API 类型
├── utils/                # 工具函数
│   ├── baseurl.ts        # BaseURL管理
│   └── navigation.ts     # 路由导航
├── App.vue               # 应用入口
├── main.ts               # 入口文件
├── pages.json            # 页面配置
├── manifest.json         # 应用manifest配置
├── 接口文档.md           # API接口文档
└── 项目功能文档.md       # 项目功能文档
```

---

## 核心功能模块

### 1. 登录认证模块

#### 1.1 功能描述

管理员登录系统后获取 Access Token，Refresh Token 由服务端通过 HttpOnly Cookie 管理，用于长期在线。

#### 1.2 页面流程

```
登录页 → 输入账号密码 → 调用登录API → 存储 Access Token → 跳转首页
                           ↓
        Access Token 即将过期/收到 401 → 调用 refresh 接口 → 更新 Access Token → 自动重试请求
```

#### 1.3 关键功能

| 功能 | 说明 |
|------|------|
| 账号密码登录 | 用户名+密码方式登录 |
| 双 Token 会话 | Access Token + Refresh Token（HttpOnly Cookie） |
| Access Token 存储 | 登录成功后存储 Access Token 和过期时间 |
| 自动续期 | 请求前检查过期，或收到 401/1001 时自动刷新 |
| 无感重试 | 刷新成功后自动重试原请求 |
| 自动跳转 | 登录成功后自动跳转到首页 |
| 错误提示 | 登录失败时显示错误信息 |

#### 1.4 相关文件

| 文件路径 | 功能 |
|----------|------|
| `pages/login/index.vue` | 登录页面 |
| `api/modules/auth.ts` | 登录/刷新/退出 API |
| `api/index.ts` | 自动刷新与重试逻辑 |
| `store/user.ts` | Access Token 状态管理 |

---

### 2. 提现管理模块

#### 2.1 功能描述

管理用户的提现申请，包括查看提现记录、确认提现、驳回提现等操作。

#### 2.2 页面流程

```
提现管理页 → 加载提现列表 → 筛选查询 → 点击记录 → 查看详情
                                                    ↓
                          确认提现 ←──── 驳回提现 ←┘
```

#### 2.3 功能列表

| 功能 | 说明 |
|------|------|
| 提现列表展示 | 分页展示所有提现记录 |
| 钱包地址搜索 | 按钱包地址模糊搜索 |
| 状态筛选 | 按提现状态筛选（待确认、处理中、已完成等） |
| 刷新列表 | 手动刷新最新数据 |
| 查看交易链接 | 点击地址查看 Tron 链上交易 |
| 确认提现 | 通过提现申请 |
| 驳回提现 | 拒绝提现申请 |

#### 2.4 状态筛选选项

| 状态值 | 显示名称 | 说明 |
|--------|----------|------|
| -3 | 已驳回 | 提现申请被拒绝 |
| -2 | 失败 | 提现操作失败 |
| -1 | 已取消 | 用户主动取消 |
| 0 | 待确认 | 待管理员处理 |
| 1 | 处理中 | 正在处理中 |
| 2 | 确认中 | 确认中 |
| 3 | 已完成 | 提现成功完成 |

#### 2.5 列表字段说明

| 字段 | 说明 |
|------|------|
| 用户名 | 发起提现的用户名 |
| 邮箱 | 用户邮箱（脱敏显示） |
| 状态 | 提现当前状态 |
| 到账金额 | 实际到账金额 |
| 提现金额 | 申请提现金额 |
| 钱包地址 | TRON 钱包地址 |
| 能量消耗 | 交易消耗的 TRX 能量 |
| 带宽消耗 | 交易消耗的 TRX 带宽 |
| 申请时间 | 发起提现的时间 |
| 确认时间 | 处理完成的时间 |

#### 2.6 操作说明

| 操作 | 触发条件 | 说明 |
|------|----------|------|
| 查看交易 | 有 tronLink 时显示 | 在浏览器中打开交易详情 |
| 确认提现 | status=0 时显示 | 弹窗确认后执行 |
| 驳回提现 | status=0 时显示 | 弹窗确认后执行 |

#### 2.7 相关文件

| 文件路径 | 功能 |
|----------|------|
| `pages/tabs/withdraw.vue` | 提现管理页面 |
| `api/modules/withdraw.ts` | 提现 API |
| `types/api.d.ts` | 类型定义 |

---

### 3. 交易管理模块

#### 3.1 功能描述

管理平台的所有交易记录，包括普通交易和自营交易，支持查看详情、结算管理、取消交易等功能。

#### 3.2 页面流程

```
交易管理页 → Tab切换（全部/自营）→ 筛选条件 → 加载列表 → 点击记录
                                                    ↓
                              ┌─────────────────────┴─────────────────────┐
                              ↓                                             ↓
                       查看详情弹窗                                    物品详情页
                              ↓                                             ↓
                        结算恢复/结算同步/取消交易                   查看物品详情列表
```

#### 3.3 功能列表

| 功能 | 说明 |
|------|------|
| Tab 切换 | 全部交易 / 自营交易 |
| 订单号搜索 | 按订单号模糊搜索 |
| 状态筛选 | 按交易状态筛选 |
| 游戏筛选 | 按游戏类型筛选（CS2/TF2/DOTA2） |
| 类型筛选 | 按交易类型筛选（卖出/求购） |
| 刷新列表 | 手动刷新最新数据 |
| 查看详情 | 弹窗展示交易详细信息 |
| 物品详情 | 跳转查看交易物品详情列表 |
| 结算恢复 | 恢复已完成的结算 |
| 结算同步 | 同步结算状态 |
| 取消交易 | 取消进行中的交易 |

#### 3.4 Tab 说明

| Tab | 标识 | 说明 |
|-----|------|------|
| 全部交易 | trade-list | 平台所有交易记录 |
| 自营交易 | trade-detail | 平台自营店铺的交易记录 |

#### 3.5 状态筛选选项

| 状态值 | 显示名称 | 说明 |
|--------|----------|------|
| -2 | 已撤销 | 交易被撤销 |
| -1 | 已取消 | 交易被取消 |
| 1 | 待付款 | 等待买家付款 |
| 2 | 待发货 | 等待卖家发货 |
| 3 | 发货待确认 | 等待买家确认收货 |
| 4 | 待接收 | 等待接收 |
| 5 | 结算中 | 交易完成，结算中 |
| 6 | 已完成 | 交易彻底完成 |
| 9 | 取消中 | 取消处理中 |

#### 3.6 游戏筛选选项

| appId | 游戏名称 |
|-------|----------|
| 730 | CS2 |
| 440 | TF2 |
| 570 | DOTA 2 |

#### 3.7 交易类型选项

| type | 类型 | 说明 |
|------|------|------|
| 1 | 卖出 | 卖家出售物品 |
| 2 | 求购 | 买家求购物品 |

#### 3.8 列表字段说明

| 字段 | 说明 |
|------|------|
| 游戏 | 交易所属游戏 |
| 订单号 | 交易唯一标识 |
| 物品名称 | 交易物品的市场名称 |
| 价格 | 物品标价 |
| 实际价格 | 扣除手续费后的价格 |
| 手续费 | 平台收取的费用 |
| 数量 | 物品数量 |
| 买家 | 买家用户名 |
| 卖家 | 卖家用户名 |
| 创建时间 | 交易创建时间 |
| 发货时间 | 卖家发货时间 |
| 收货时间 | 买家确认收货时间 |
| 结束时间 | 交易完成时间 |
| 结算倒计时 | 保护期剩余时间 |

#### 3.9 操作按钮

| 操作 | 触发条件 | 说明 |
|------|----------|------|
| 查看详情 | 所有记录 | 弹窗展示完整交易信息 |
| 物品详情 | 所有记录 | 跳转物品详情页面 |
| 更改 Offer | status ∈ {-2,-1,2,3,5,9} | 更改 Steam 报价 |
| 取消交易 | status=2 | 待发货状态下可取消 |
| 结算同步 | status=5 | 结算中状态下同步状态 |
| 结算恢复 | status=6 | 已完成状态下恢复结算 |

#### 3.10 详情弹窗内容

| 区块 | 字段 |
|------|------|
| 基本信息 | 订单号、Offer ID、游戏、物品名称、Schema ID、类型 |
| 交易信息 | 状态、标识、数量、评价分数 |
| 价格信息 | 价格、实际价格、手续费 |
| 用户信息 | 买家名称、买家ID、卖家名称、卖家ID、是否自营 |
| 时间信息 | 创建、发货、收货、结束、保护期 |
| 取消信息 | 取消原因、取消描述 |
| 错误信息 | 错误列表 |

#### 3.11 相关文件

| 文件路径 | 功能 |
|----------|------|
| `pages/tabs/trade.vue` | 交易管理页面 |
| `pages/trade-detail.vue` | 物品详情页面 |
| `api/modules/trade.ts` | 交易 API |
| `types/api.d.ts` | 类型定义 |

---

### 4. 工单管理模块

#### 4.1 功能描述

管理用户提交的问题工单，支持查看工单详情、会话式回复、启用/取消技术支持、忽略工单等操作。

#### 4.2 页面流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          工单管理页                                          │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────────────┐     │
│  │ 工单列表    │───→│ 点击工单    │───→│ 工单详情页                   │     │
│  │ - 状态筛选  │    │             │    │ - 查看工单信息              │     │
│  │ - 搜索      │    │             │    │ - 技术支持开关              │     │
│  │ - 待回复徽章│    │             │    │ - 忽略工单                  │     │
│  └─────────────┘    └─────────────┘    │ - 查看会话按钮 ────────┐     │
│                                          └─────────────────────────│─────┘
│                                              ┌───────────────────────↓───────┐
│                                              │                             │  │
│                                     ┌────────┴────────┐         ┌──────────▼─────────┐
│                                     │  会话聊天页      │         │  操作                │
│                                     │  - 聊天式界面   │         │  - 启用/取消技术支持  │
│                                     │  - 发送回复     │         │  - 忽略工单          │
│                                     │  - 上传图片     │         │                     │
│                                     │  - 查看历史     │         └─────────────────────┘
│                                     └─────────────────┘
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 4.3 功能列表

**工单列表页** (`pages/tabs/ticket.vue`):

| 功能 | 说明 |
|------|------|
| 工单列表展示 | 分页展示所有工单 |
| 待回复快捷按钮 | 右上角浮动按钮，显示待回复数量，快速筛选待处理工单 |
| Steam ID 搜索 | 按 Steam ID 模糊搜索 |
| 状态筛选 | 按工单状态筛选（待回复/已回复/已解决/已关闭） |
| 忽略筛选 | 切换显示/忽略的工单 |
| 下拉刷新 | 下拉刷新最新数据 |
| 上拉加载 | 滚动到底部自动加载更多 |
| 点击查看 | 点击工单跳转详情页 |

**工单详情页** (`pages/ticket-detail.vue`):

| 功能 | 说明 |
|------|------|
| 工单信息展示 | 显示工单ID、状态、创建人、创建时间、Steam ID |
| 反馈内容显示 | 展示用户提交的问题描述 |
| 错误信息列表 | 显示关联的错误信息 |
| 标签显示 | 技术支持标签、已忽略标签 |
| 技术支持开关 | 启用/取消技术支持 |
| 忽略工单操作 | 标记/取消忽略工单 |
| 查看会话按钮 | 跳转到会话聊天页面 |
| 返回列表 | 返回工单列表页 |

**工单会话页** (`pages/ticket-chat.vue`):

| 功能 | 说明 |
|------|------|
| 聊天式界面 | 类似即时通讯的聊天界面 |
| 原始工单展示 | 显示用户提交的原始工单内容 |
| 回复列表展示 | 按时间顺序展示所有回复 |
| 消息气泡区分 | 管理员和用户消息使用不同样式 |
| 图片附件支持 | 回复支持上传多张图片 |
| 图片预览 | 点击图片可全屏预览 |
| 发送回复 | 发送文本回复和图片附件 |
| 自动滚动 | 新消息自动滚动到底部 |
| 输入工具栏 | 图片上传按钮、文本输入框、发送按钮 |

#### 4.4 状态筛选选项

| 状态值 | 显示名称 | 状态颜色 | 说明 |
|--------|----------|----------|------|
| 0 | 待回复 | 橙色 | 待管理员回复 |
| 1 | 已回复 | 蓝色 | 管理员已回复 |
| 2 | 已解决 | 绿色 | 问题已解决 |
| 3 | 已关闭 | 灰色 | 工单已关闭 |

#### 4.5 工单列表字段说明

| 字段 | 说明 |
|------|------|
| 工单标题 | 工单问题摘要 |
| 工单 ID | 工单唯一标识 |
| 状态 | 工单当前状态（带颜色标识） |
| 创建人 | 工单发起人 |
| 创建时间 | 工单创建时间 |
| Steam ID | 关联的 Steam 账户 |
| 技术支持标签 | 是否已启用技术支持（蓝色标签） |
| 已忽略标签 | 是否已忽略（灰色标签） |

#### 4.6 会话功能说明

**消息样式区分**:

| 发送者 | 气泡样式 | 背景色 | 对齐方式 | 头像 |
|--------|----------|--------|----------|------|
| 管理员 | 管理员气泡 | 主色调（蓝紫色） | 右对齐 | 管理员图标 |
| 用户 | 用户气泡 | 卡片背景色 | 左对齐 | 用户首字母 |

**图片上传**:

| 功能 | 说明 |
|------|------|
| 选择图片 | 从相册选择图片，最多9张 |
| 图片预览栏 | 显示已上传图片的缩略图 |
| 删除图片 | 点击缩略图上的删除按钮移除 |
| 全屏预览 | 点击消息中的图片可全屏查看 |
| 网格布局 | 单图大图显示，多图网格排列 |

#### 4.7 操作说明

| 操作 | 触发条件 | 说明 |
|------|----------|------|
| 启用技术支持 | status=0 | 启用后显示"技术支持"标签 |
| 取消技术支持 | 已启用技术支持 | 取消后移除"技术支持"标签 |
| 忽略工单 | status=0 且未忽略 | 忽略后显示"已忽略"标签，不会出现在默认列表 |
| 取消忽略 | 已忽略 | 取消忽略状态，恢复显示 |
| 查看会话 | 所有工单 | 跳转到会话聊天页面 |
| 发送回复 | 会话页 | 发送文本和图片回复 |

#### 4.8 相关文件

| 文件路径 | 功能 |
|----------|------|
| `pages/tabs/ticket.vue` | 工单列表页面 |
| `pages/ticket-detail.vue` | 工单详情页面 |
| `pages/ticket-chat.vue` | 工单会话聊天页面 |
| `api/modules/ticket.ts` | 工单 API |
| `types/api.d.ts` | 类型定义 |

---

### 5. 个人信息模块

#### 5.1 功能描述

展示当前登录管理员的个人信息，支持退出登录。

#### 5.2 功能列表

| 功能 | 说明 |
|------|------|
| 个人信息展示 | 显示管理员的基本信息 |
| 退出登录 | 清除登录状态，返回登录页 |

#### 5.3 展示字段

| 字段 | 说明 |
|------|------|
| 用户名 | 登录账号 |
| 邮箱 | 关联邮箱 |
| 昵称 | 显示昵称 |
| 真实姓名 | 真实姓名 |
| 角色 | 所属角色 |

#### 5.4 相关文件

| 文件路径 | 功能 |
|----------|------|
| `pages/tabs/profile.vue` | 个人信息页面 |
| `api/modules/user.ts` | 用户 API |

---

### 6. 服务器地址管理模块

#### 6.1 功能描述

管理 API 服务器地址，支持多服务器环境切换、连通性测试等功能，方便开发、测试、生产环境切换。

#### 6.2 功能列表

| 功能 | 说明 |
|------|------|
| 当前地址显示 | 显示当前使用的服务器地址 |
| 服务器列表 | 展示已保存的所有服务器地址 |
| 添加服务器 | 添加新的服务器地址 |
| 切换服务器 | 切换到指定的服务器地址 |
| 删除服务器 | 删除已保存的服务器地址 |
| 连通性测试 | 自动测试所有服务器的连通性 |

#### 6.3 数据结构

```typescript
interface BaseURLItem {
  id: string          // 唯一标识
  name: string        // 服务器名称（如：生产环境、测试服务器）
  url: string         // 服务器地址（如：https://www.tronskins.com）
  isDefault?: boolean // 是否为默认服务器
}
```

#### 6.4 存储配置

| 存储键 | 类型 | 说明 |
|--------|------|------|
| `api_baseurl_current` | string | 当前使用的服务器地址 |
| `api_baseurl_list` | BaseURLItem[] | 已保存的服务器列表 |

#### 6.5 连通性测试

- **测试方法**: 发送 HEAD/GET 请求到 `/api/admin/auth/login`
- **超时时间**: 5000ms
- **状态指示**:
  - 绿灯 - 连接成功
  - 红灯 - 连接失败
  - 灰色 - 未知状态
  - 加载动画 - 测试中

#### 6.6 相关文件

| 文件路径 | 功能 |
|----------|------|
| `pages/baseurl/index.vue` | 服务器地址管理页面 |
| `utils/baseurl.ts` | BaseURL 管理工具 |

---

### 7. 应用更新模块

#### 7.1 功能描述

自动检查应用更新，支持热更新（.wgt）和完整更新（.apk）两种方式。

#### 7.2 更新流程

```
应用启动 → 检查更新 → 发现新版本 → 下载更新包 → 安装更新 → 提示重启
```

#### 7.3 更新类型

| 类型 | 文件扩展名 | 说明 |
|------|-----------|------|
| 热更新 | .wgt | 资源更新，无需重启应用，安装后立即生效 |
| 完整更新 | .apk | 完整安装包，需要用户手动下载安装 |

#### 7.4 更新参数

| 参数 | 说明 |
|------|------|
| appkey | 应用标识（`tronskins-admin-app`） |
| versionName | 当前版本号（如 `1.0.0`） |
| hotVersion | 热更新版本号（如 `2026012301`） |
| platform | 平台（`android` 或 `ios`） |

#### 7.5 更新说明

- 应用启动时自动检查更新（全局只检查一次）
- 热更新自动下载并安装，安装后提示重启
- APK 更新跳转浏览器下载
- 更新进度通过弹窗实时显示

#### 7.6 相关文件

| 文件路径 | 功能 |
|----------|------|
| `utils/app-update.ts` | 应用更新工具 |

---

## 状态管理

### Store: UserStore

#### 状态定义

```typescript
interface UserState {
  token: string                         // Access Token
  accessTokenExpireTime: number | null  // Access Token 过期时间（毫秒时间戳）
  authHeader: string                    // 认证头名称（默认 X-Service-Authorization）
  userInfo: UserInfo | null             // 管理员信息
}
```

#### 主要功能

| 功能 | 说明 |
|------|------|
| setAccessToken | 设置 Access Token、过期时间、认证头 |
| setToken | 兼容旧调用（内部转 setAccessToken） |
| setUserInfo | 设置用户信息 |
| clearAuthState | 清理认证状态（不清用户资料） |
| logout | 退出登录，清除所有状态 |
| isLoggedIn | 检查是否已登录 |
| isAccessTokenExpired | 检查 Access Token 是否即将过期 |
| initUser | 从持久化存储恢复状态 |

#### 持久化配置

- **存储键**: `user-store`
- **持久化字段**: `token`, `userInfo`, `accessTokenExpireTime`, `authHeader`

#### 相关文件

| 文件路径 | 功能 |
|----------|------|
| `store/user.ts` | 用户状态管理 |

---

### Store: AppStore

#### 状态定义

```typescript
interface AppState {
  theme: 'light' | 'dark'        // 主题模式
  language: 'zh-CN' | 'en-US'    // 语言设置
}
```

#### 主要功能

| 功能 | 说明 |
|------|------|
| setTheme | 设置主题模式 |
| setLanguage | 设置应用语言 |
| toggleTheme | 切换主题（亮色/暗色） |
| toggleLanguage | 切换语言（中文/英文） |
| initTheme | 从持久化存储恢复主题和语言 |

#### 持久化配置

- **存储键**: `app-store`
- **持久化字段**: `theme`, `language`
- **存储位置**: `app_theme`, `app_language`

#### 相关文件

| 文件路径 | 功能 |
|----------|------|
| `store/app.ts` | 应用状态管理 |

---

## 国际化

### 支持语言

| 语言 | 代码 |
|------|------|
| 中文 | zh |
| 英文 | en |

### 语言文件结构

```typescript
// locales/zh.ts / en.ts
export default {
  common: {
    loading: '加载中...',
    confirm: '确认',
    cancel: '取消',
    error: '错误',
    // ...
  },
  login: {
    title: '登录',
    username: '用户名',
    password: '密码',
    login: '登录',
    // ...
  },
  withdraw: {
    // 提现相关文案
  },
  trade: {
    // 交易相关文案
  },
  ticket: {
    // 工单相关文案
  },
  profile: {
    // 个人信息相关文案
  }
}
```

### 切换语言

在设置页面或应用设置中切换语言后，自动刷新页面以应用新语言。

### 相关文件

| 文件路径 | 功能 |
|----------|------|
| `locales/zh.ts` | 中文语言包 |
| `locales/en.ts` | 英文语言包 |
| `locales/index.ts` | 语言配置导出 |

---

## 主题系统

### 支持主题

| 主题 | 说明 |
|------|------|
| light | 亮色主题 |
| dark | 暗色主题 |

### 主题变量

```scss
// 亮色主题
--c-bg: #F4F6F8        // 背景色
--c-card: #FFFFFF      // 卡片背景
--c-main: #4F46E5      // 主色调
--t-primary: #111827   // 主要文字
--t-regular: #4B5563   // 常规文字
--t-light: #9CA3AF     // 浅色文字
--c-border: #F3F4F6    // 边框色
--c-divider: rgba(0, 0, 0, 0.06)  // 分割线

// 暗色主题
--c-bg: #0B0F19
--c-card: #111827
--c-main: #6366F1
--t-primary: #F9FAFB
--t-regular: #9CA3AF
--t-light: #6B7280
--c-border: #1F2937
--c-divider: rgba(255, 255, 255, 0.06)
```

### 切换主题

在设置页面切换主题后，自动应用到整个应用。

---

## API 通信

### 请求配置

| 配置项 | 值 |
|--------|-----|
| 基础URL | `https://www.tronskins.com`（可动态配置） |
| 默认URL | `https://www.tronskins.com` |
| 超时时间 | 30000ms |
| Content-Type | `application/json` |
| withCredentials | `true`（认证相关请求，用于携带 Refresh Token Cookie） |

### 动态 BaseURL

应用支持动态切换 API 服务器地址：

- 当前使用的地址存储在 `api_baseurl_current`
- 已保存的地址列表存储在 `api_baseurl_list`
- 每次请求时动态获取当前 BaseURL
- 支持在设置页面添加、删除、切换服务器

### 请求头

| 头名称 | 说明 |
|--------|------|
| Content-Type | 固定为 `application/json` |
| X-Service-Authorization | Access Token（直接传递，不带 Bearer 前缀） |
| Authorization | 备用认证头（Bearer Token 格式） |
| X-Device-Type | 客户端类型（APP-PLUS 自动添加为 `app`） |

### 响应格式

```json
{
  "code": 0,          // 状态码：0 或 200 表示成功
  "message": "成功",  // 提示信息
  "datas": {}         // 响应数据
}
```

### 错误处理

| 错误码 | 说明 | 处理 |
|--------|------|------|
| 0 | 成功 | 返回数据 |
| 401 | Access Token 过期/未授权 | 优先尝试刷新 Token，失败后跳转登录页 |
| 1001 | Token 无效 | 优先尝试刷新 Token，失败后跳转登录页 |
| 其他 | 业务错误 | 显示错误提示 |

### Token 管理

系统采用双 Token 模式：

1. 登录成功后写入：
   - `user_token`：Access Token（兼容读取旧键 `token`）
   - `access_token_expire_time`：Access Token 过期时间
   - `authHeader`：认证头名称
2. Refresh Token 不落地到 JS 存储，由后端通过 HttpOnly Cookie 管理
3. 请求前检测 Access Token 是否即将过期，必要时自动调用 `/api/app/auth-manager/refresh`
4. 若返回 401/1001，也会触发一次自动刷新并重试原请求
5. 刷新失败或 Refresh Token 失效时清理登录态并跳转登录页

### 相关文件

| 文件路径 | 功能 |
|----------|------|
| `api/index.ts` | 请求入口 |
| `api/config/index.ts` | 请求配置和拦截器 |
| `api/modules/*.ts` | 各模块 API |

---

## UI 组件

### 主要组件

| 组件 | 说明 |
|------|------|
| u-button | 按钮组件 |
| u-icon | 图标组件 |
| u-loading-icon | 加载动画 |
| u-empty | 空状态提示 |
| u-modal | 弹窗确认框 |
| u-picker | 选择器 |
| u-popup | 弹出层 |
| u-tabs | 标签页 |

### 组件使用示例

```vue
<template>
  <!-- 按钮 -->
  <u-button type="primary" @click="handleClick">按钮</u-button>

  <!-- 图标 -->
  <u-icon name="search" size="18"></u-icon>

  <!-- 加载 -->
  <u-loading-icon mode="circle" size="60"></u-loading-icon>

  <!-- 空状态 -->
  <u-empty text="暂无数据" mode="data"></u-empty>

  <!-- 弹窗 -->
  <u-modal :show="show" title="标题" @confirm="onConfirm"></u-modal>

  <!-- 选择器 -->
  <u-picker :show="show" :columns="columns" @confirm="onConfirm"></u-picker>

  <!-- 弹出层 -->
  <u-popup :show="show" mode="bottom" @close="onClose"></u-popup>
</template>
```

---

## 页面路由

### 页面配置 (pages.json)

| 路径 | 页面 | 说明 |
|------|------|------|
| /pages/login/index | 登录页 | 管理员登录 |
| /pages/index/index | 首页 | 应用首页（Tab 容器） |
| /pages/baseurl/index | 服务器地址 | 服务器地址管理 |
| /pages/tabs/withdraw | 提现管理 | 提现记录管理 |
| /pages/tabs/trade | 交易管理 | 交易记录管理 |
| /pages/tabs/ticket | 工单管理 | 工单列表 |
| /pages/tabs/profile | 个人信息 | 当前用户信息 |
| /pages/trade-detail | 物品详情 | 交易物品详情 |
| /pages/trade-record-detail | 交易详情 | 交易记录详情 |
| /pages/withdraw-detail | 提现详情 | 提现记录详情 |
| /pages/ticket-detail | 工单详情 | 工单详情查看 |
| /pages/ticket-chat | 工单会话 | 工单聊天回复 |

### 路由跳转

```typescript
// 跳转页面
uni.navigateTo({
  url: '/pages/trade-detail?recordId=123&appId=730'
})

// 关闭页面返回
uni.navigateBack()

// 跳转登录页（登录过期时）
uni.reLaunch({
  url: '/pages/login/index'
})
```

---

## 工具函数

### BaseURL 管理工具 (`utils/baseurl.ts`)

| 函数 | 说明 |
|------|------|
| `getCurrentBaseURL()` | 获取当前使用的服务器地址 |
| `setCurrentBaseURL(url)` | 设置当前服务器地址 |
| `getBaseURLList()` | 获取已保存的服务器列表 |
| `saveBaseURLList(list)` | 保存服务器列表 |
| `addBaseURL(name, url)` | 添加新的服务器地址 |
| `deleteBaseURL(id)` | 删除指定的服务器地址 |
| `switchBaseURL(url)` | 切换到指定的服务器地址 |
| `validateURL(url)` | 验证 URL 格式是否正确 |
| `formatURL(url)` | 格式化 URL（去除尾部斜杠） |

### 路由导航工具 (`utils/navigation.ts`)

| 函数 | 说明 |
|------|------|
| `redirectToLogin()` | 跳转到登录页（防止重复跳转） |

### 时间格式化

```typescript
// 时间戳转格式化时间
formatTime(timestamp: string): string {
  const date = new Date(Number(timestamp) * 1000)
  const year = date.getFullYear()
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  const hour = String(date.getHours()).padStart(2, '0')
  const minute = String(date.getMinutes()).padStart(2, '0')
  return `${year}-${month}-${day} ${hour}:${minute}`
}
```

### 倒计时计算

```typescript
// 计算倒计时
getCountdown(protectionTime: string | undefined): string {
  if (!protectionTime) return ''
  const now = Math.floor(Date.now() / 1000)
  const target = Number(protectionTime)
  const diff = target - now
  if (diff <= 0) return ''
  // 返回格式化的时间差
}
```

### 外部链接打开

```typescript
// 打开外部链接
openLink(url: string): void {
  // #ifdef H5
  window.open(url, '_blank')
  // #endif
  // #ifndef H5
  plus.runtime.openURL(url)
  // #endif
}
```

---

## 附录

### 应用信息

| 配置项 | 值 |
|--------|-----|
| 应用名称 | Tronskins后台管理 |
| APPID | __UNI__90F66E1 |
| 版本号 | 1.0.0 |
| 版本代码 | 2026012301 |
| 描述 | TronSkins 后台管理系统 App |

### 存储键说明

| 存储键 | 类型 | 说明 |
|--------|------|------|
| `user_token` | string | Access Token |
| `token` | string | 旧版 Access Token 键（兼容读取） |
| `access_token_expire_time` | number | Access Token 过期时间（毫秒时间戳） |
| `user_info` | UserInfo | 用户信息 |
| `authHeader` | string | 认证头名称 |
| `app_theme` | 'light' \| 'dark' | 应用主题 |
| `app_language` | 'zh-CN' \| 'en-US' | 应用语言 |
| `api_baseurl_current` | string | 当前服务器地址 |
| `api_baseurl_list` | BaseURLItem[] | 服务器地址列表 |

### 数据类型定义

详见 `接口文档.md` 中的 TypeScript 类型定义附录。

### 错误码参考

详见 `接口文档.md` 中的错误码参考部分。

### 接口文档

详见 `接口文档.md`。
